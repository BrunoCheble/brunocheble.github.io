<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="dhtmlxgantt.js"></script>
  <script src="./activities/script.js"></script>

  <link rel="stylesheet" href="dhtmlxgantt.css?v=8.0.6">
  <link rel="stylesheet" href="./activities/styles.css">
  <title>Document</title>
  <style>
    .gantt_task_progress_drag, .gantt_task_drag.task_left.task_start_date, .gantt_task_drag.task_right.task_end_date {
      display: none!important;
    }
  </style>
</head>

<body>
  <div style="padding: 10px; background-color: #f5f5f5; display: flex; justify-content: space-between;">
    <div>
    <button class="btn" id="btnBack">Voltar</button>
    <span id="page_chart"></span>
    <button class="btn" id="btnNext">Avançar</button>
    </div>
    <button class="btn" id="btnSave">Guardar</button>
  </div>
  <div id="gantt_here" style='width:100%; height:100%;'></div>

  <script>
    function init() {
      function alertGantt(text, type, expire) {

        gantt.message({
          text,
          type,
          expire
        });
      }

      function updateGannttData() {

        const data = calculateActivityDates(activities).map(a => {
          return {
            id: a.id,
            text: a.name,
            start_date: a.start_date,
            duration: calculateDaysBetweenDates(a.start_date, a.end_date) + 1,
            parent: a.dependent_id ? a.dependent_id : 1000,
            progress: a.progress,
            open: true,
          }
        })

        const startDate = new Date(Math.min(...activities.map(a => new Date(a.start_date))));
        const endDate = new Date(Math.max(...activities.map(a => new Date(a.end_date))));

        data.push({
          id: 1000,
          text: "Project",
          start_date: activities[0].start_date,
          duration: calculateDaysBetweenDates(startDate, endDate) + 1,
          open: true,
          type: "project"
        })

        links = data.map(a => {
          return {
            id: a.id,
            source: a.parent,
            target: a.id,
            type: "0"
          }
        })

        gantt.parse({
          data,
          links
        });
      }

      function beforeGanttLoad() {

        gantt.config.grid_width = 380;
        gantt.config.add_column = false;
        /*gantt.config.columns = [
          {name: "text", label: "Task name", tree: true, width: '*'},
          {
            name: "progress", label: "Progress", width: 80, align: "center",
            template: function (item) {
              if (item.progress >= 1)
                return "Complete";
              if (item.progress == 0)
                return "Not started";
              return Math.round(item.progress * 100) + "%";
            }
          },
          {name: "duration", label: "Duration",  width: 80, align: "center"},
        ];*/
        
        gantt.config.date_format = "%Y-%m-%d %H:%i";
        gantt.config.start_on_monday = false;

        gantt.plugins({
          marker: true,
          tooltip: true,
          drag_timeline: false,
          drag_move: false,
          drag_resize: false,
          drag_progress: false
        });

        gantt.attachEvent("onGanttReady", function() {
          var tooltips = gantt.ext.tooltips;
          tooltips.tooltip.setViewport(gantt.$task_data);
        });

        var dateToStr = gantt.date.date_to_str(gantt.config.task_date, "pt-BR");
        var today = new Date(2024, 8, 5);

        gantt.addMarker({
          start_date: today,
          css: "today",
          text: "Today",
          title: "Today: " + dateToStr(today)
        });
        gantt.locale.labels["section_parent"] = "Parent task";
        gantt.locale.labels["section_progress"] = "Progress";

        gantt.config.lightbox.sections = [{
            name: "description",
            height: 38,
            map_to: "text",
            type: "textarea",
            focus: true
          },
          {
            name: "parent",
            type: "parent",
            allow_root: "true",
            root_label: "No parent",
            filter: function(id, task) {
              return true;
            }
          },
          {
            name: "progress", height: 22, map_to: "progress", type: "select", options: [
              {key: "0", label: "Not started"},
              {key: "0.1", label: "10%"},
              {key: "0.2", label: "20%"},
              {key: "0.3", label: "30%"},
              {key: "0.4", label: "40%"},
              {key: "0.5", label: "50%"},
              {key: "0.6", label: "60%"},
              {key: "0.7", label: "70%"},
              {key: "0.8", label: "80%"},
              {key: "0.9", label: "90%"},
              {key: "1", label: "Complete"}
            ]
          },
          {
            name: "time",
            type: "duration",
            map_to: "auto"
          },
        ];
      }

      function afterGanttLoad() {
        gantt.init("gantt_here");

        // Configura a escala do Gantt para duas linhas
        gantt.config.scale_unit = "day";
        gantt.config.date_scale = "%d %M";

        // Function to format the date and day of the week in English
        function formatDateWithDayOfWeek(dateString) {
          const date = new Date(dateString); // Parse t
          const dayOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][date.getDay()];
          const options = {
            day: 'numeric',
            month: 'short'
          };
          const formattedDate = date.toLocaleDateString('en-US', options);
          return `${dayOfWeek}<br>${formattedDate}`;
        }

        gantt.config.subscales = [{
          unit: "day",
          step: 1,
          template: function(date) {
            return formatDateWithDayOfWeek(date)
          }
        }];
        gantt.config.scale_height = 50;
      }

      beforeGanttLoad();

      afterGanttLoad();

      updateGannttData();

      gantt.attachEvent("onTaskDurationChange", function(id, new_duration) {
        console.log("A duração da atividade foi alterada");
        console.log("ID da atividade:", id);
        console.log("Nova duração:", new_duration);
    });
      // Evento que dispara após abrir o lightbox
      gantt.attachEvent("onLightbox", function(task_id) {
        const activity = getActivity(task_id);

        // Custom logic to run after the lightbox is opened
        const duration = document.querySelector(".gantt_duration input.gantt_duration_value");

        if (duration) {
          duration.value = activity?.duration || 1;
        }
      });

      // Configura o lightbox para incluir o campo personalizado
      gantt.attachEvent("onLightboxSave", function(id, task, is_new) {
        // Validação para garantir que work_time é um número
        const workTime = document.querySelector(".gantt_section_work_time input.gantt_duration_value");

        if (!workTime) {
          return true;
        }

        const work_time = parseInt(workTime.value, 10);

        if (!isNaN(work_time)) {
          task.work_time = work_time;
        } else {
          const activity = getActivity(id);
          task.work_time = activity.duration;
        }

        console.log(task.work_time);
        return true;
      });

      gantt.attachEvent("onAfterTaskAdd", async function(id, item) {
        createActivity(item);
        calculateActivityDates();
        updateGannttData();
        await updateActivities();
        document.querySelector("#page_chart").innerHTML = `${index_chart+1}/${bkp_activities.length}`;
        return true;
      });

      gantt.attachEvent("onTaskDrag", function(id, mode, task, original) {
        const activity = getActivity(id);
        task.duration = activity.duration;
      });

      gantt.attachEvent("onBeforeTaskDelete", function(id, task) {
        //any custom logic here
        if (task.type == "project") {
          alertGantt("Projeto não pode ser excluído", "error", 3000);
          return false;
        }

        if (activities.length == 1) {
          alertGantt("Não pode excluir a última tarefa do projeto", "error", 3000);
          return false;
        }

        return true;
      });

      gantt.attachEvent("onAfterTaskDelete", async function(id, task) {
        removeActivity(id);
        calculateActivityDates();
        updateGannttData();
        await updateActivities();
        document.querySelector("#page_chart").innerHTML = `${index_chart+1}/${bkp_activities.length}`;
        return true;
      });

      gantt.attachEvent("onAfterTaskUpdate", async function(id, item) {

        const activity = getActivity(id);

        if (!activity) {
          window.location.reload();
          return;
        }

        if (!validateChangeDate(item)) {
          calculateActivityDates();
          updateGannttData();
          alertGantt("A data da tarefa não pode ser inferior a data final da tarefa anterior", "error", 3000);
          return false;
        }

        if (!updateActivity(item, activity)) {
          return false;
        }

        if (hasChildren(id) && confirm("recalcular as datas dos dependentes?")) {
          resetDependencyActivities(id);
        }

        calculateActivityDates();
        updateGannttData();
        await updateActivities();
        document.querySelector("#page_chart").innerHTML = `${index_chart+1}/${bkp_activities.length}`;
        return true;
      });

      document.querySelector("#btnSave").addEventListener("click", async function() {
        await updateActivities();
      });

      document.querySelector("#btnBack").addEventListener("click", function() {
        navigateHistory('back');
      });

      document.querySelector("#btnNext").addEventListener("click", function() {
        navigateHistory('next');
      });

      function navigateHistory(direction) {
        if (direction === 'back' && index_chart > 0) {
          index_chart--;
        } else if (direction === 'next' && index_chart < bkp_activities.length - 1) {
          index_chart++;
        } else {
          return;
        }

        activities = JSON.parse(JSON.stringify(bkp_activities[index_chart]));
        calculateActivityDates();
        updateGannttData();
        document.querySelector("#page_chart").innerHTML = `${index_chart+1}/${bkp_activities.length}`;
      }
    }

    (async function() {
      await loadActivities();
      init();
    })();
  </script>
</body>

</html>